---
lab:
    title: 'ラボ 10a: リリース ゲートを使用したデプロイの制御'
    module: 'モジュール 10: リリース戦略の設計'
---

# ラボ 10a: リリース ゲートを使用したデプロイの制御
# 受講生用ラボ マニュアル

## ラボの概要

このラボでは、デプロイ ゲートの構成と、それらを使用して Azure Pipelines の実行を制御する方法について詳しく説明します。それらの実装を説明するために、Azure Web アプリの 2 つの環境でリリース定義を構成します。アプリのブロック バグがない場合にのみ、カナリア環境にデプロイし、Azure Monitor の Application Insights にアクティブなアラートがない場合にのみ、カナリア環境を完了としてマークします。

リリース パイプラインは、さまざまな環境にデプロイされるアプリケーションのエンドツーエンドのリリース プロセスを指定します。各環境へのデプロイは、ジョブとタスクを使用して完全に自動化されます。アプリケーションに対する新しい更新プログラムをすべてのユーザーに同時に公開することは理想的です。更新を段階的に公開する、つまり、ユーザーのサブセットに公開し、使用状況を監視し、最初のユーザー セットの経験に基づいて他のユーザーに公開するのがベストプラクティスです。

承認とゲートにより、リリースのデプロイの開始と完了を制御できます。承認により、ユーザーがデプロイを手動で承認または拒否するのを待つことができます。リリース ゲートを使用すると、リリースが次の環境に昇格する前に満たす必要があるアプリケーション正常性基準を指定できます。環境デプロイの前後に、指定されたすべてのゲートは、すべてのゲートが合格するか、定義されたタイムアウト期間に達して失敗するまで自動的に評価されます。

ゲートは、デプロイ前の条件またはデプロイ後の条件パネルから、リリース定義の環境に追加できます。環境条件に複数のゲートを追加して、リリースに対するすべての入力が正常に行われるようにすることができます。

例

- デプロイ前のゲートは、ビルドを環境にデプロイする前に、作業項目または問題管理システムにアクティブな問題がないことを確認します。
- デプロイ後のゲートは、アプリがデプロイされた後、次の環境にリリースをプロモートする前に、アプリの監視システムまたはインシデント管理システムからのインシデントがないことを確認します。

すべてのアカウントには、既定で 4 種類のゲートが含まれています。

- Azure 関数の呼び出し: Azure 関数の実行をトリガーし、正常に完了するようにします。 
- Azure Monitor アラートのクエリ: アクティブなアラートの構成済みの Azure Monitor 警告ルールを確認します。 
- REST API の呼び出し: REST API を呼び出して、成功した応答が返されたら続行します。 
- 作業項目のクエリ: クエリから返された一致する作業項目の数がしきい値内であることを確認してください。 

## 目標

このラボを完了すると、次のことができるようになります。

-   リリース パイプラインを構成する
-   リリース ゲートを構成する
-   リリース ゲートをテストする

## ラボの所要時間

-   推定時間: **75 分**

## 手順

### 開始する前に

#### ラボの仮想マシンにログインする

次の認証情報を使用して、Windows 10 仮想マシンにサインインしていることを確認します。
    
-   ユーザー名: **Student**
-   パスワード: **Pa55w.rd**

#### このラボで必要なアプリケーションのレビュー

このラボで使用するアプリケーションを特定:
    
-   Microsoft Edge

#### Azure DevOps 組織を設定します。 

このラボで使用できる Azure DevOps 組織がまだない場合は、[組織またはプロジェクト コレクションの作成](https://docs.microsoft.com/ja-jp/azure/devops/organizations/accounts/create-organization?view=azure-devops)で利用できる手順に従って作成してください。

#### Azure サブスクリプションの準備

-   既存の Azure サブスクリプションを使用するか、新しいものを作成します。
-   Azure サブスクリプションでは所有者のロール、Azure サブスクリプションに関連のある Azure AD テナントではグローバル管理者のロールで Microsoft アカウントまたは Azure AD アカウントがあることを確認します。詳細については、[Azure portal を使用して Azure ロールの割り当てを一覧表示する](https://docs.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-list-portal) および [Azure Active Directory で管理者ロールを表示して割当てる](https://docs.microsoft.com/ja-jp/azure/active-directory/roles/manage-roles-portal#view-my-roles) を参照してください。

### 演習 0: ラボの前提条件の構成

この演習では、ラボの前提条件を設定します。これには、Azure DevOps DemoGenerator テンプレートに基づく事前構成済みの PartsUnlimited チームプロジェクトと、**カナリア**環境と**本番環境**を表す 2 つの Azure Web アプリが含まれます。これは、Azure Pipelines を介してアプリケーションをデプロイします。

#### タスク 1: チーム プロジェクトを構成する

このタスクでは、Azure DevOps Demo Generator を使用して、**ReleaseGates** テンプレートに基づいて新しいプロジェクトを生成します。

1.  ラボのコンピューターで Web ブラウザーを起動し、[Azure DevOps Demo Generator](https://azuredevopsdemogenerator.azurewebsites.net) に移動します。このユーティリティ サイトは、ラボで必要なコンテンツ (作業項目、リポジトリなど) が事前設定されている新しい Azure DevOps プロジェクトをアカウント内で作成するプロセスを自動化します。 

    > **注**: サイトの詳細については、https://docs.microsoft.com/ja-jp/azure/devops/demo-gen をご覧ください。

1.  「**サインイン**」をクリックし、Azure DevOps サブスクリプションに関連のある Microsoft アカウントを使用してサインインします。

1.  必要な場合は、「**Azure DevOps Demo Generator**」ページで「**承諾する**」をクリックし、Azure DevOps サブスクリプションへのアクセス許可要求を承諾します。

1.  「**新しいプロジェクトの作成**」ページの 「**新しいプロジェクト名**」テキストボックスに、「**Controlling Deployments using Release Gates**」と入力し、「**組織の選択**」ドロップダウン リストで、Azure DevOps 組織を選択して、「**テンプレートの選択**」をクリックします。

1.  テンプレートのリストのツールバーで、「**DevOps Labs**」をクリックし、**ReleaseGates** テンプレートを選択して、「**テンプレートの選択**」をクリックします。

1.  再び「**新しいプロジェクトの作成**」ページで「**プロジェクトの作成**」をクリックします。

    > **注**: プロセスが完了するまでお待ちください。これにはおよそ 2 分かかる場合があります。プロセスが失敗した場合は、DevOps 組織に移動し、プロジェクトを削除して、再試行してください。

1.  「**新しいプロジェクトの作成**」ページで「**プロジェクトに移動**」をクリックします。

#### タスク 2: 2 つの Azure Web アプリを作成する

このタスクでは、**カナリア**環境と**本番**環境を表す 2 つの Azure Web アプリを作成し、Azure Pipelines を介してアプリケーションをデプロイします。

1.  ラボのコンピューターで Web ブラウザーを起動し、[**Azure Portal**](https://portal.azure.com) に移動します。このラボで使用する Azure サブスクリプションで所有者のロールがあり、このサブスクリプションに関連のある Azure ADテナントでグローバル管理者のロールがあるユーザー アカウントを使ってサインインします。
1.  Azure portal で、ページ上部の検索テキスト ボックスのすぐ右側にある **Cloud Shell** アイコンをクリックします。 
1.  **Bash** または **PowerShell** のいずれかを選択するためのプロンプトが表示されたら、「**Bash**」 を選択します。 

    >**注**: **Cloud Shell** を起動するのが初めてであり、「**ストレージがマウントされていません**」のメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、「**ストレージを作成**」 を選択します。 

1.  **Bash** プロンプトの 「**Cloud Shell**」ペインで、次のコマンドを実行してリソースグループを作成します (`<region>` プレースホルダーを 2 つの Azure Web アプリをホストする Azure リージョンの名前に置き換えます(たとえば、'eastus'))。

    > **注**: 次のコマンドを実行すると、可能な場所を見つけることができます。`<region>` の**名前**を使用します。`az account list-locations -o table`

   
    ```bash
    RESOURCEGROUPNAME='az400m10l01-RG'
    az group create -n $RESOURCEGROUPNAME -l '<region>'
    ```

1.  アプリ サービス プランを作成する
   
    ```bash
    SERVICEPLANNAME='az400m01l01-sp1'
    az appservice plan create -g $RESOURCEGROUPNAME -n $SERVICEPLANNAME --sku S1
    ```
1.  ユニークなアプリ名を持つ 2 つの Web アプリを作成します。
 
     ```bash
     SUFFIX=$RANDOM$RANDOM
     az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n PU$SUFFIX-Canary
     az webapp create -g $RESOURCEGROUPNAME -p $SERVICEPLANNAME -n PU$SUFFIX-Prod
     ```

1.  このタスクの前半で作成したリソース グループ **az400m10l01-RG** に移動し、作成したリソースを確認します。

#### タスク 3: Application Insights のリソースを構成する

1. Azure Portal で **Application Insights** を検索し、Application Insights ページに移動します。

1. 「**＋ 作成**」をクリック

1. **リソースグループ** として **az400m10|01-RG** を選択。

1. **名前** に Canary Webアプリの名前を指定（PU<数字>-Canary）

1. **場所** に WEBアプリと同じリージョンを指定

1. **リソースモード** を **クラシック** に変更

1. 「**確認および作成**」をクリックし、さらに「**作成**」をクリック。

1. デプロイが完了するまで待ちます。

1. **az400m10l01-RG** リソースグループに移動します。

1. リソースのリストで、**カナリア** Web アプリをクリックします。 

1.  **カナリア** Web アプリ ページの左側の垂直メニューの 「**設定**」セクションで、「**Application Insights**」をクリックします。

1.  「**Application Insights**」ブレードで、「**Application Insights を有効にする**」をクリックします。

1. **既存のリソースの選択** を選択し、先ほど作成した Application Insights リソースを選択し「**適用**」をクリックします。

1.  Application Insights のリソースが作成されるまで待ち、中央に表示される「アプリは 次の Application Insights リソースに接続されています」というメッセージに表示されているリンクをクリックします。

    > **注**: ここでモニター アラートを作成します。これは、このラボの後半で使用します。 

1.  「**Application Insights リソース**」ウィンドウで、「**アラート**」オプション (「監視」の下) をクリックし、「**+ 新しいアラート ルール**」をクリックします。

1.  「**アラートルール の作成**」ブレードの 「**条件**」セクションで、「**条件の追加**」リンクをクリックします。 

1.  「**シグナルの選択**」ブレードの 「**シグナル名で検索**」テキストボックスで「**Failed Requests**」を検索し、ヒットしたシグナルをクリックします。

1.  「**シグナルロジックの構成**」ブレードの 「**アラート ロジック**」セクションで、「**しきい値**」を 「**Static**」のままにし、「**しきい値**」テキストボックスに **0**と 入力して、「**完了**」をクリックします。

    > **注**: ルールは、過去 5 分間に失敗したリクエストの数が 0 を超えると、アラートを生成します。 

1.  「**アラート ルールの作成**」ペインに戻ったら、下にスクロールして「**アラート ルールの詳細**」で次の設定を指定し、「**アラート ルールの作成**」をクリックします (他のユーザーはデフォルト値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | アラート ルール名 | **PartsUnlimited_FailedRequests** |
    | 重要度 | **重大度 2** |

    > **注**: メトリック アラートをルールがアクティブになるまでに最大 10 分かかる場合があります。

    > **注**: 可用性 < 99%、サーバー応答時間 > 5 秒、サーバー例外 > 0など、さまざまなメトリックで複数のアラート ルールを作成できます。 

### 演習 1: リリース パイプラインを構成する

この演習では、リリース パイプラインを構成します。

#### タスク 1: リリース タスクを更新する

このタスクでは、リリース タスクを更新します。

1.  ラボ コンピューターで、Azure DevOps ポータルの 「**Controlling Deployments using Release Gates**」プロジェクトを表示するブラウザー ウィンドウに切り替え、垂直ナビゲーション ペインで 「**パイプライン**」を選択し、「**パイプライン**」セクションで 「**リリース**」をクリックします。 
1.  「**リリース**」ビューの 「**PartsUnlimited-CD**」ペインで、「**Edit**」をクリックします。

    > **注**: パイプラインには、**Canary Environment** と **Production** という名前の 2 つのステージが含まれています。 

1.  「**Pipeline**」タブの 「**Artifacts**」長方形で、**PartsUnlimited-CI**ビルド アーティファクトの右上隅にある 「**Continuous deployment trigger**」ボタン（カミナリのマーク）をクリックします。

1.  **PartsUnlimited-CI** ビルドの **Continuous deployment trigger** が無効になっている場合は、スイッチを切り替えて **Enabled** にします。他のすべての設定をデフォルトのままにし、右上隅の **x** マークをクリックして閉じます。 

1.  **Canary Envitonment**ステージ内で、**1 job、2 tasks**のラベルをクリックします。

    > **注**: カナリア環境には 2 つのタスクがあり、それぞれパッケージを Azure Web App に公開し、デプロイ後のアプリケーションの継続的な監視を可能にします。 

1.  **「All pipelines > PartsUnlimited-CD」** ペインで、「**Canary Environment**」ステージが選択されていることを確認します。

1.  右側の「**Azure subscription**」ドロップダウン リストで、Azure サブスクリプションを選択し、「**Authorize**」をクリックします。プロンプトが表示されたら、Azure サブスクリプションの所有者ロールを持つユーザー アカウントを使用して認証します。

1.  「**App Service Name**」ドロップダウンリストで、**Canary** Web アプリの名前を選択します。

1.  「**リソース グループと Application insights**」ドロップダウン リストで、**az400m10l01-RG** エントリを選択します。

1.  「**Application Insights Resource Name**」ドロップダウン リストで、**Canary** Application Insights リソースの名前を選択します。これは、**Canary** Web アプリの名前と一致しているはずです。 

1.  「**Tasks**」タブをクリックし、ドロップダウン リストで 「**Production**」を選択します。

1.  「**Production**」 ステージを選択し、「**Azure subscription**」 ドロップダウン リストで 「**Canary Environtment**」 ステージで使用した Azure サブスクリプションを選択します (「**Available Azure Service Connections**」 にあります)。このサービス接続は以前にサブスクリプションの使用を承認した際、すでに作成されているためです。

1. 「**App Service Name**」ドロップダウン リストで、**Prod** Web アプリの名前を選択します。

1. **「All pipelines > PartsUnlimited-CD」** ペインで、「**Save**」をクリックし、「**Save**」ダイアログ ボックスで 「**OK**」をクリックします。

1. 垂直ナビゲーション ペインで「**Pipelines**」をクリックし、**PartsUnlimited-CI** ビルド パイプラインを表すエントリをクリックしてから、**Run pipeline**」をクリックします。 

1. 「**Run pipeline**」ペインで、デフォルト設定を受け入れ、「**Run**」をクリックしてパイプラインをトリガーします。  **ビルド パイプラインが完了するまで待ちます**。

    > **注**: ビルドが成功すると、リリースが自動的にトリガーされ、アプリケーションが両方の環境にデプロイされます。

1. 垂直ナビゲーション の 「**パイプライン**」セクションで 「**Releases**」をクリックし、「**PartsUnlimited-CD**」ペインで最新のリリースを表すエントリをクリックします。

1. **PartsUnlimited-CD > Release-1** ブレードで、リリースの進行状況を追跡し、両方の Web アプリへのデプロイが正常に完了したことを確認します。

1. Azure portal インターフェイスに切り替え、リソース グループ **az400m10l01-RG** に移動し、リソースのリストで**カナリア** Web アプリをクリックし、Web アプリ ブレードで 「**参照**」をクリックして、Web ページが新しい Web ブラウザー タブに正常に読み込まれることを確認します。

1. **Parts Unlimited** Web サイトを表示している Web ブラウザー タブを閉じます。

1. Azure portal インターフェイスに切り替え、リソース グループ **az400m10l01-RG** に移動し、リソースのリストで**本番** Web アプリをクリックし、Web アプリ ブレードで 「**参照**」をクリックして、Web ページが新しい Web ブラウザー タブに正常に読み込まれることを確認します。

1. **Parts Unlimited** Web サイトを表示している Web ブラウザー タブを閉じます。

    > **注**: これで、CI/CD で構成されたアプリケーションができました。次の演習では、リリース パイプラインにゲートを設定します。

### 演習 2: リリース ゲートを構成します。

この演習では、リリース パイプラインにゲートを設定します。

#### タスク 1: デプロイ前ゲートを構成する

このタスクでは、デプロイ前ゲートを構成します。

1.  Azure DevOps ポータルを表示する Web ブラウザー ウィンドウに切り替え、垂直ナビゲーション ペインの 「**パイプライン**」セクションで 「**リリース**」をクリックし、「**PartsUnlimited-CD**」ペインで 「**Edit**」をクリックします。

1.  **All pipelines > PartsUnlimited-CD** ペインで、**Canary Environment**ステージを表す長方形の左端で、**Pre-Deployment conditions**を表す楕円形をクリックします。

1.  「**Pre-deployment conditions**」ウィンドウで、「**Pre-deployment approvals**」スライダーを 「**Enabled**」に設定し、「**Approvers**」テキスト ボックスに Azure DevOps アカウント名を入力して選択します。 

1.  「**Gates**」スライダーを 「**Enabled**」に設定し、「**+ Add**」をクリックして、ポップアップ メニューで 「**Query work items**」をクリックします。

1.  「**The delay before evaluation**」設定の値を **5 分**のままにします。 

    > **注**: **The delay before evaluation - 評価前の遅延**は、追加されたゲートが最初に評価されるまでの時間を表します。ゲートが追加されていない場合、デプロイは続行する前にその期間待機します。ゲート機能を初期化して安定させるために (正確な結果が返されるまでに時間がかかる場合があります)、結果が評価され、デプロイが承認または拒否されるかどうかを判断するために使用されるまでの遅延を構成します。

1.  「**Query work items**」セクションの 「**query**」ドロップダウン リストで、「**Shared queries**」の下の 「**bug**」を選択し、**Upper threshold**の値を **0** のままにします。

    > **注**: **上限しきい値**設定の値に基づいて、この場合クエリはアクティブなバグ作業アイテムを返し、リリース ゲートは失敗します。

1.  画面の下にある「**Evaluation options**」セクションを展開し、次のオプションを構成します

    - **The time between re-evaluation of gates**の値を **5 minutes**に設定します。

    > **注**: **The time between re-evaluation of gates - ゲートの再評価間の時間**は、すべてのゲートの各評価間の時間間隔を表します。各サンプリング間隔で、新しい要求が各ゲートに同時に送信され、新しい結果が得られます。サンプリング間隔は、すべての応答を受信できるように、構成されたゲートの通常の最長応答時間よりも長くする必要があります。

    - **The timeout after which gates fail**の値を **8 minutes**に設定します。

    > **注**: **The timeout after which gates fail - ゲートが失敗するまでのタイムアウト**は、すべてのゲートの最大評価期間を表します。同じサンプリング間隔ですべてのゲートが成功する前にタイムアウトに達すると、デプロイは拒否されます。タイムアウトに指定できる最小値は、サンプリング間隔として 6 分と 5 分です。

    > **注**: この場合、リリースがトリガーされると、ゲートは *0 分*と *5 分*にサンプルを検証します。結果が**合格**の場合、承認のために通知が送信されます。結果が**失敗**の場合、リリースは *8* 分後にタイムアウトになります。

    > **注**: 実際には、これらの値は複数時間にわたる場合があります。 

1.  「**On successful gates, ask for approval - 成功したゲートで承認を求める**」ラジオ ボタンを選択します。

1.  右上隅の **x** マークをクリックして、「**デプロイ前の条件**」ペインを閉じます。

1.  リリース パイプラインの変更を 「**Save**」 します。

1.  **Query work items** ゲートが機能するには、**プロジェクト ビルド サービス**に Azure Board クエリの **読み取りアクセス許可** が必要です。

1.  Azure DevOps ポータルの垂直ナビゲーション ペインで、「**ボード**」に移動し、「**Queries**」をクリックします。

1.  **ボード** ビューの 「**クエリ**」ペインで、「**All**」をクリックして、すべてのクエリのリストを取得します。

1.  「**共有クエリ**」フォルダーを右クリックし、「**Security...**」を選択して、「**Permissions for Shared Queries**」ペインを開きます。

1.  「**Permissions for Shared Queries**」ペインの 「**ユーザーまたはグループの検索**」フィールドに、**Controlling Deployments using Release Gates Build Service** と入力し、見つかった ID をクリックします。

    > **注**: **Controlling Deployments using Release Gates Build Service**ユーザーは、上記のように検索する必要があります。**ユーザー** リストのメンバーとしてはまだ表示されていません。ユーザーの **Project Collection Build Service** と **Project Build Service** を混同しないでください。

1.  「**ユーザー**」リストで 「**Controlling Deployments using Release Gates Build Service**」ユーザーを選択し、右側のサイトで 「**Read**」アクセス許可を 「**Allow**」に設定します。

1.  右上隅の **x** マークをクリックして、ペインを閉じます。

1.  リリース パイプラインに戻ります。
   
#### タスク 2: デプロイ後のゲートを構成する

このタスクでは、カナリア環境のデプロイ後のゲートを有効にします。

1.  **Canary Environment**ステージを表す長方形の右端で、**Post-deployment conditions**を表す楕円形をクリックします。

1.  「**Post-deployment conditions**」ペインで、「**Gate**」スライダーを 「**有効**」に設定し、「**+ 追加**」をクリックして、ポップアップ メニューで 「**Query Azure Monitor alerts**」をクリックします。

1.  「**Query Azure Monitor alerts**」 セクションの 「**Azure サブスクリプション**」 ドロップダウン リストで、Azure サブスクリプションを表すエントリを選択し (「利用可能な Azure サービス」 にあります)、「**リソース グループ**」 ドロップダウン リストで、**az400m10l01-RG** エントリを選択します。

1.  「**Evaluation Options**」オプションを展開し、次のオプションを構成します。

- **The time between re-evaluation of gates - ゲートの再評価間の時間**の値を **5 分**に設定します。
- **The timeout after which gates fail**の値を **8 分**に設定します。
- 「**On successful gates, ask for approvals**」オプションを選択します。

    > **注**: サンプリング間隔とタイムアウトは連携して機能するため、ゲートは適切な間隔で関数を呼び出し、タイムアウト期間内の同じサンプリング間隔で成功しなかった場合はデプロイを拒否します。 

1.  右上隅の **x** マークをクリックして、ペインを閉じます。
1.  **PartsUnlimited-CD** ペインに戻り、「**保存**」をクリックし、「**保存**」ダイアログ ボックスでもう一度 「**保存**」をクリックします。 


### 演習 3  リリース ゲートをテストする

この演習では、アプリケーションを更新してリリース ゲートをテストします。これにより、デプロイがトリガーされます。

#### タスク 1: リリース ゲートを追加した後、アプリケーションを更新しデプロイする

このタスクでは、アプリケーション コードに小さな変更を加え、リポジトリに更新をコミットし、ビルドとリリースのプロセスを追跡します。

1.  Azure DevOps ポータルを表示しているブラウザー ウィンドウの垂直ナビゲーション ペインで、「**Releases**」を選択します。 

1.  「**Create release**」 をクリックし、既定のまま 「**Create**」 をクリックします。

1.  最新の実行エントリをクリックして、**Canary Environment**へのデプロイの進行状況を確認します。 

1.  **Canary Environment**ステージを表す長方形の左端にある**デプロイ前**の状態を表す楕円形をクリックします。

1.  「**Canary Environment**」ペインで、**作業項目のクエリ** ゲートが失敗したことに注意してください。

    > **注**: これは、アクティブな作業項目があることを示しています。先に進むには、これらの作業項目を閉じる必要があります。次のサンプリング時間は 5 分後です。

1.  新しいブラウザー タブを開き、Azure DevOps ポータルに移動し、垂直ナビゲーション ペインで 「**Boards**」を選択し、「**Queries**」を選択します。

1.  「**Queries**」ペインで、「**All**」タブをクリックします。

1.  「**Shared Queries**」セクションで、「**Bug**」エントリをクリックし、「**Run query**」をクリックします。 

1.  クエリが、**Disk out of space in Canary Envieonment**というタイトルの作業項目を返すことを確認します。

    > **注**: インフラストラクチャ チームがディスク容量の問題を修正したと仮定しましょう。 

1.  「**Disk out of space in Canary Envieonment**」エントリをクリックします。

1.  右側に表示された「**Disk out of space in Canary Envieonment**」ペインで、左上の 「**State**」ラベルの横にある 「**New**」をクリックし、ドロップダウン リストで 「**Closed**」をクリックして、「**Save**」をクリックします。

1.  「**Canary Environment**」ペインに戻り、2 番目の評価が合格するのを待ちます。 

    > **注**: 2 番目の評価がすでに失敗した場合は、**Canary Environment**ステージを表す長方形の上にマウスポインターを置いて 「**再デプロイ**」オプションを表示し、「**再デプロイ**」をクリックし、「**カナリア環境**」ブレードで、「**デプロイ**」をクリックし、デプロイ前のゲートの処理ステータスを監視します。 

    > **注**: 評価が成功すると、デプロイ前の承認のリクエストが表示されます。 

1.  カナリア環境にデプロイするには、「**Approve**」をクリックします。

    > **注**: が成功すると、Application Insights を使用して、新しくデプロイされたアプリケーションを対象とする失敗したリクエストの存在を検出するデプロイ後のゲートが動作します。 

1.  **Canarey** Azure Web アプリ に移動します。

1.  PartsUnlimited Web サイトで、メニューバーで「**More**」をクリックします。

    > **注**: Web サイトのこの部分は意図的に誤って構成されているため、失敗した要求がトリガーされます。 

1.  PartsUnlimited Web サイトのホームページに戻り、何度か 「**More**」をクリックします。

1.  Azure Portal で **Canary** Web アプリ ページの Application Insights ブレードに移動し、「**Application Insights データの表示**」をクリックします。

1.  **失敗した要求**が Application Insights によって検出されたことを検証します。

1.  Application Insights ブレードで 「**アラート**」をクリックして、ページに 1 つ以上の **Sev2** アラートがリストされていることを確認します。 

    > **注**: 例外によってトリガーされるアラートがあるため、**Query AzureMonitor** ゲートは失敗します。これにより、**本番**環境への展開が妨げられます。

### 演習 4: Azure ラボ リソースを削除する

この演習では、このラボでプロビジョニングした Azure リソースを削除し、予期しない料金を排除します。 

>**注**: Azure リソースのうち、使用しないリソースは必ず削除してください。使用しないリソースを削除しないと、予期しないコストが発生する場合があります。

#### タスク 1: Azure ラボ リソースを削除する

このタスクでは、Azure Cloud Shell を使用して、このラボでプロビジョニングされた Azure リソースを削除し、不要な料金を排除します。 

1.  Azure portal で、**Cloud Shell** ウィンドウ内で **Bash** シェル セッションを開きます。
1.  次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを表示します。

    ```sh
    az group list --query "[?starts_with(name,'az400m10l01-RG')].name" --output tsv
    ```

1.  次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを削除します。

    ```sh
    az group list --query "[?starts_with(name,'az400m10l01-RG')].[name]" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
    ```

    >**注**: コマンドは非同期に実行されるので (--nowait パラメーターで決定される)、同じ Bash セッション内ですぐに別の Azure CLI コマンドを実行できますが、リソース グループが実際に削除されるまでに数分かかります。

## レビュー

このラボでは、リリース パイプラインを構成してから、リリース ゲートを構成してテストしました。 
