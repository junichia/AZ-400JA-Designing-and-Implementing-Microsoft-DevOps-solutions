---
lab:
    title: 'ラボ 10b: リリース ダッシュボードの作成'
    module: 'モジュール 10: リリース戦略の設計'
---

# ラボ 10b: リリース ダッシュボードの作成
# 受講生用ラボ マニュアル

## ラボの概要

このラボでは、リリース ダッシュボードの作成と、REST API を使用して Azure DevOps リリース データを取得する手順を説明します。これにより、カスタム アプリケーションまたはダッシュボードでこの方法を利用できるようになります。 

ラボでは、Azure DevOps Starter リソースを活用します。このリソースは、アプリケーションをビルドして Azure にデプロイする Azure DevOps プロジェクトを自動的に作成します。 

## 目標

このラボを完了すると、次のことができるようになります。

- リリース ダッシュボードを作成する
- REST API を使用してリリース情報を取得する

## ラボの所要時間

-   推定時間: **45 分**

## 手順

### 開始する前に

#### ラボの仮想マシンにログインする

必ず次の資格情報を使用して Windows 10 コンピューターにサインインしてください。
    
-   ユーザー名: **Student**
-   パスワード: **Pa55w.rd**

#### インストールされているアプリケーションを確認します

Windows 10 デスクトップでタスク バーを探します。タスク バーには、この課題で使用するアプリケーションのアイコンが含まれています:
    
-   Microsoft Edge

#### Azure DevOps 組織を設定する

このラボで使用できる Azure DevOps 組織がまだない場合は、[組織またはプロジェクト コレクションの作成](https://docs.microsoft.com/ja-jp/azure/devops/organizations/accounts/create-organization?view=azure-devops)で利用できる手順に従って作成してください。

#### Azure サブスクリプションの準備

-   既存の Azure サブスクリプションを識別するか、新しいものを作成します。
-   Azure サブスクリプションで所有者のロールを持つ Microsoft アカウントまたは Azure AD アカウントを持っていることを確認します。詳細については、「[Azure ポータルを使用した Azure のロールの割り当ての一覧表示](https://docs.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-list-portal)」を参照してください。

### 演習 1 リリース ダッシュボードを作成する

この演習では、Azure DevOps 組織にリリース ダッシュボードを作成します。

#### タスク 1: Azure DevOps Starter リソースを作成する

このタスクでは、Azure サブスクリプションに Azure DevOps Starter リソースを作成します。これにより、Azure DevOps 組織に対応するプロジェクトが自動的に作成されます。 

1.  ラボ コンピューターで、Web ブラウザーを起動し、[**Azure Portal**](https://portal.azure.com) に移動して、このラボで使用する Azure サブスクリプションで所有者または共同作成者のロールを持つユーザー アカウントでサインインします。

1.  Azure portal で、**DevOps Starter** リソースの種類を検索して選択し、**DevOps Starter** ブレードで「**+ 追加**」をクリックします。 

1.  「**DevOps Starter**」ブレードの「**Start fresh with a new application**」ペインで、**.NET**　タイルを選択し、上部にある「Setting up DevOps starter with GitHub, change settings」の横の **here** リンクをクリックし、「**Azure DevOps**」、「**Done**」、「**Next: Framework >**」を選択します。 

1.  「**ASP.NET Core**」タイルを選択し、「**Add a database**」スライダーを 「**On**」の位置に移動して、「**Next: Service >** をクリックします。 

1.  「**Windows Web App**」タイルが選択されていることを確認し、「**Next: Create >** をクリックします。 

1.  「**Almost there!**」ペイン上で、次の設定を指定します。

    | 設定 | 値 |
    | ------- | ----- |
    | プロジェクト名 | **リリース ダッシュボードの作成** |
    | Azure DevOps 組織 | このラボで使用する予定の Azure DevOps 組織の名前 |
    | サブスクリプション | このラボで使用する Azure サブスクリプションの名前 |
    | Web アプリの名前 | 文字、数字、ハイフンで構成され、文字または数字で開始および終了する 2 〜 60 文字のグローバルに一意の文字列 |
    | 場所 | Azure Web アプリと Azure SQL データベースをデプロイする Azure リージョンの名前 |

1.  下にある「**Additional Settings**」をクリックします。
1.  次の設定を指定して 「**OK**」をクリックします。

    | 設定 | 値 |
    | ------- | ----- |
    | リソース グループ | **az400m10l02-rg** |
    | 価格レベル | **S1 Standard** |
    | Application Insights の場所 | Azure Web アプリの場所として選択したのと同じ Azure リージョンの名前 |
    | サーバー名 | 文字、数字、ハイフンで構成され、文字または数字で開始および終了する 3 〜 63 文字のグローバルに一意の文字列 |
    | ユーザー名を入力 | **dbadmin** |
    | 場所 | Azure Web アプリの場所として選択したのと同じ Azure リージョンの名前 |
    | データベース名 | **az400m10l02-db** |

1.  「**DevOps Starter**」ブレードに戻り、「**Review + create**」の順にクリックします。

    > **注**: デプロイが完了するまで待ちます。**DevOps Starter** リソースのプロビジョニングには約 2 分かかります。

1.  DevOps Starter リソースがプロビジョニングされたことの確認を受け取ったら、「**リソースに移動**」ボタンをクリックします。これにより、ブラウザーが DevOps Starter ブレードにリダイレクトされます。

1.  DevOps Starter ブレードで、CI/CD パイプラインが正常に完了するまで進行状況を追跡します。 画面をリフレッシュしながら確認してください。

    > **注**: 対応する Azure Web アプリと Azure SQL データベースの作成には約 5 分かかる場合があります。このプロセスにより、すぐにデプロイできるリポジトリとビルドおよびリリース パイプラインを含む Azure DevOps プロジェクトが自動的に作成されます。Azure リソースは、自動的にトリガーされるデプロイ パイプラインの一部として作成されます。 

#### タスク 2: Azure DevOps リリースを作成する

このタスクでは、デプロイが失敗するリリースを含む、いくつかの Azure DevOps リリースを作成します。

1.  Azure portal で DevOps を検索し、**Azure DevOps Organizations** をクリックします。演習で使用している Organization に移動します。

1.  プロジェクトの一覧から **リリースダッシュボードの作成**をクリックします。

    > **注**: はじめに正常なリソースをデプロイします。

1.  Azure DevOps ポータルの左側の垂直メニューで 「**リポジトリ**」をクリックし、リポジトリ内のフォルダーのリストで、**Applications\\aspnet-core-dotnet-core\\Pages** フォルダーに移動し、**Index.cshtml** エントリをクリックします。 

1.  「**Index.cshtml**」ペインで、「**Edit**」をクリックし、**20** 行目の `<div class="description line-2"> Your ASP.NET Core app is up and running on Azure</div>` を `<div class="description line-2"> Your ASP.NET Core app v1.1 is up and running on Azure</div>` に置き替え、「**コミット**」をクリックして、「**コミット**」ペインで、もう一度 「**コミット**」をクリックします。これにより、ビルド パイプラインが自動的にトリガーされます。 

1.  Azure DevOps ポータルの左側の垂直ナビゲーション ペインで、「**パイプライン**」をクリックします。

1.  「**パイプライン**」ペインの 「**Recent**」タブで、**<以前に設定したWebAppの名前>-CI** エントリをクリックし、「**Runs**」タブで、最新の実行を選択します。実行の 「**Summary**」タブで、「**Jobs**」セクションの 「**Build**」をクリックし、正常に完了するまでジョブを監視します。 

1.  ジョブが完了したら、Azure DevOps ポータルの左側の垂直ナビゲーションペインの 「**パイプライン**」セクションで、「**リリース**」をクリックします。

1.  **<以前に設定したWebAppの名前>-CD** ペインの 「**Releases**」タブで 「**Release-2** 」エントリをクリックし、**dev**ステージをクリックし、「**View Logs**」をクリックして、正常に完了するまで、デプロイの進行状況を監視します。 

    > **注**: 次にデプロイが失敗する新しいリリースを作成します。失敗の原因は、新しいリリースに関連する変更が無効であると見なされる組み込みアセンブリ テストです。

1.  Azure DevOps ポータルの左側の垂直メニューで 「**リポジトリ**」をクリックし、リポジトリ内のフォルダーのリストで、**Applications\\aspnet-core-dotnet-core\\Pages** フォルダーに移動し、**Index.cshtml** エントリをクリックします。 

1.  「**Index.chtml**」ペインで、「**Edit**」をクリックし、**4** 行目の `    ViewData ["Title"] = "Home Page - ASP.NET Core";` を `    ViewData["Title"] = "Home Page v1.2 - ASP.NET Core";` に置き替え、「**Commit**」をクリックし、「**Commit**」ペインでもう一度 「**Commit**」をクリックします。これにより、ビルド パイプラインが自動的にトリガーされます。 

1.  Azure DevOps ポータルの左側の垂直ナビゲーション ペインで、「**パイプライン**」をクリックします。

1.  「**パイプライン**」ペインの 「**最近**」タブで、**<以前に設定したWebAppの名前>-CI** エントリをクリックし、「**Runs**」タブで、最新のリリース実行を選択します。実行の 「**Summary**」タブで、「**Jobs**」セクションの 「**Build**」をクリックし、正常に完了するまでジョブを監視します。 

1.  ジョブが完了したら、Azure DevOps ポータルの左側の垂直ナビゲーションペインの 「**パイプライン**」セクションで、「**リリース**」をクリックします。

1.  **<以前に設定したWebAppの名前>-CD** ペインの 「**リリース**」タブで最新のリリースジョブをクリックし、「**パイプライン**」タブで **dev** ステージをクリックし、「**View logs**」をクリックして、**Test Assemblies** ステップで失敗するまで、デプロイの進行状況を監視します。 

#### タスク 3: Azure DevOps リリース ダッシュボードを作成する

このタスクでは、ダッシュボードを作成し、それにリリース関連のウィジェットを追加します。

1.  Azure DevOps ポータルの左側の垂直メニューで 「**Overview**」をクリックし、その配下の「**Dashboards**」をクリックして、「**Add a widget**」をクリックします。

1.  右側のウィジェットのリストを下にスクロールし、「**Deployment Status**」エントリを選択して、「**Add**」をクリックします。

1.  同じように、**Release Pipeline Overview**、**Release Pipeline Overview**ウィジェットを追加します。

1.  ダッシュボード ペインに戻り、**デプロイ ステータス** ウィジェットを表す長方形で、「**ギアアイコン（ウィジェットの構成）**」をクリックします。 

1.  「**構成**」ペインで、次の設定を指定し (他のすべての設定はデフォルト値のままにします)、「**保存**」をクリックします。

    | 設定 | 値 |
    | ------- | ----- |
    | ビルド パイプライン | **<以前に設定したWebAppの名前> - CI** |
    | Linked release pipelines | **<以前に設定したWebAppの名前> - CD; <以前に設定したWebAppの名前> - CD\dev** |

1.  ダッシュボードペインに戻り、「**Release pipeline Overview**」ウィジェットを表す長方形の右上隅の「**ギアアイコン（ウィジェットの構成）**」をクリックします。、それをクリックして、ドロップダウンメニューで 「**構成**」をクリックします。  

1.  「**構成**」ペインで、次の設定を指定し (他のすべての設定はデフォルト値のままにします)、「**保存**」をクリックします。

    | 設定 | 値 |
    | ------- | ----- |
    | リリース パイプライン | **<以前に設定したWebAppの名前> - CD** |

1. **Done Editing** をクリックします。

1.  ダッシュボードペインにバック、ウィジェットで表示されるコンテンツを更新するには、「**Refresh**」クリックします。

    > **注**: ウィジェット上のリンクを使用すると、Azure DevOps ポータルの対応するペインに直接移動できます。

### 演習 2: REST API を介してリリース情報をクエリする

この演習では、Postman を使用して REST API を介してリリース情報をクエリします。

#### タスク 1: Azure DevOps 個人用アクセス トークンを生成する

このタスクでは、Azure DevOps 個人用アクセス トークンを生成します。これは、この演習の次のタスクでインストールする Postman アプリからの認証に使用されます。

1.  Azure DevOps ページの右上コーナーにある「**User settings**」アイコンをクリックします。ドロップダウン メニューで「**Personal Access Tokens**」をクリックし、「**+ New Token**」をクリックします。
1.  「**新しい個人用アクセス トークンの作成**」ペインで、一番下にある「**Show all scopes**」リンクをクリックし、以下の設定を行い「**作成**」をクリックします (他はすべて、既定値のままにします):

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **リリース ダッシュボード ラボの作成** |
    | スコープ | **Build** |
    | アクセス許可 | **読み取り** |
    | スコープ | **Release** |
    | アクセス許可 | **読み取り** |

1.  「**Success**」ペインで個人用アクセス トークンの値をクリップボードにコピーします。

    > **注**: 必ずトークンの値を記録してください。このペインを閉じると、取得できなくなります。 

1. 「**Close**」をクリックします。

#### タスク 2: Postman を使用して REST API を介してリリース情報をクエリする

このタスクでは、Postman を使用して REST API を介してリリース情報をクエリします。

1.  ラボ コンピューターで、Web ブラウザーを起動し、[Postman ダウンロードページ](https://www.postman.com/downloads/)に移動し、「**アプリのダウンロード**」ボタンをクリックし、ドロップダウン メニューで、「**Windows 64 ビット**」をクリックし、ダウンロードしたファイルをクリックして、インストールを実行します。インストールが完了すると、Postman デスクトップ アプリが自動的に起動します。 

1.  「**Postman アカウントの作成**」ペインで、メール アドレス、ユーザー名、パスワードを入力し、「**無料アカウントの作成**」をクリックします。 

    > **注**: アカウント プロビジョニングのプロセスを完了し、Postman アカウントをアクティブ化するために、Postman からメールが届きます。

1.  サインインしたら、Postman デスクトップ アプリ ウィンドウの左上にある 「**+ New**」をクリックし、「**HTTP Request**」をクリックします。

1.  Postman デスクトップ アプリの中央にある「**Authorization**」タブをクリックし、「**Type**」ドロップダウン リストで 「**Basic Auth**」エントリを選択し、「**パスワード**」テキスト ボックスに前のタスクでコピーしたトークンの値を貼り付けます (「**ユーザー名**」テキスト ボックスの値を設定しないでください)。

1.  アプリウィンドウで **GET** が表示されていることを確認し、すべてのリリースを一覧表示するためのURLを以下のように入力して「**Send**」をクリックします (`<organization_name>` の値を Azure DevOps 組織の名前に置き換えます)。

    ```url
    https://vsrm.dev.azure.com/<organization_name>/リリース%20ダッシュボードの作成/_apis/release/releases?api-version=6.0
    ```

1.  「**Body**」タブにリストされている出力を確認し、このラボの前の演習で作成したリリースのリストが含まれていることを確認します。

1.  次に、すべてのデプロイ一覧を表示するために、以下のように URL を入力して 「**Send**」をクリックします (`<organization_name>` の値を Azure DevOps 組織の名前に置き換えます)。

    ```url
    https://vsrm.dev.azure.com/<organization_name>/リリース%20ダッシュボードの作成/_apis/release/deployments?api-version=6.0
    ```

1. 「**Body**」タブにリストされている出力を確認し、このラボの前の演習で作成したデプロイのリストが含まれていることを確認します。

1.  次に、失敗したデプロイを表示するために、以下のように URL を入力して 「**Send**」をクリックします  (`<organization_name>` の値を Azure DevOps 組織の名前に置き換えます)。

    ```url
    https://vsrm.dev.azure.com/<organization_name>/Creating%20a%20Release%20Dashboard/_apis/release/deployments?DeploymentStatus=failed&api-version=6.0
    ```

1.  アプリウィンドウの右下のセクションにある 「**本文**」タブにリストされている出力を確認し、このラボの前の演習で開始した失敗した展開のみが含まれていることを確認します。

### 演習 3: Azure ラボ リソースを削除する

この演習では、このラボでプロビジョニングした Azure リソースを削除し、予期しない料金を排除します。 

>**注**: Azure リソースのうち、使用しないリソースは必ず削除してください。使用しないリソースを削除しないと、予期しないコストが発生する場合があります。

#### タスク 1: Azure ラボ リソースを削除する

このタスクでは、Azure Cloud Shell を使用して、このラボでプロビジョニングされた Azure リソースを削除し、不要な料金を排除します。 

1.  Azure portal で、**Cloud Shell** ウィンドウ内で **Bash** シェル セッションを開きます。
1.  次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを表示します。

    ```sh
    az group list --query "[?starts_with(name,'az400m10l02-rg')].name" --output tsv
    ```

1.  次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを削除します。

    ```sh
    az group list --query "[?starts_with(name,'az400m10l02-rg')].[name]" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
    ```

    >**注**: コマンドは非同期に実行されるので (--nowait パラメーターで決定される)、同じ Bash セッション内ですぐに別の Azure CLI コマンドを実行できますが、リソース グループが実際に削除されるまでに数分かかります。

#### レビュー

このラボでは、リリース ダッシュボードを作成および構成する方法と、REST API を使用して Azure DevOps リリースデータを取得する方法を学習しました。
